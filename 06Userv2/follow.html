<!DOCTYPE html>

<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <script type="text/javascript" src="../jquery.min.js"></script>
    <script type="text/javascript" src="../settings.js"></script>
    <script type="text/javascript" src="../osql.js"></script>

    <script>
        var x;
        $().ready(function() {
            setUserId();
            showAllUsers();
            showFollowing();
            showFollowers();
        });

        function button1Pressed() {
            doInsert();
        }

        function button2Pressed() {
            doSelect();
        }

        function setUserId() {
            var userid = osql.getParam("userid");
            document.getElementById("tf1").value = userid;
        }

        async function doInsert() {
            var fromid = document.getElementById("tf1").value;
            var toid = document.getElementById("tf2").value;

            var sql = `insert into Follows values("${fromid}", "${toid}");`;
            var objects = await osql.connect(sql);
            console.log(objects);

            document.getElementById("follow-result").innerHTML = "フォローしました";
            document.getElementById("tf2").value = "";
            showAllUsers();
            showFollowing();
            showFollowers();
        }

        async function showAllUsers() {
            var sql = "select * from Users;";
            var objects = await osql.connect(sql);
            console.log(objects);
            var html = "";
            html += "<table border=1>";
            html += "<tr><th>id</th><th>name</th></tr>";
            for (var i = 0; i < objects.length; i++) {
                var object = objects[i];
                html += "<tr>";
                html += "<td>" + object.id + "</td>";
                html += "<td>" + object.name + "</td>";
                html += "</tr>";
            }
            html += "</table>";
            document.getElementById("users-table").innerHTML = html;
        }

        async function showFollowing() {
            var fromid = document.getElementById("tf1").value;
            var sql = `select toid, name from Users inner join Follows on Users.id = Follows.toid where fromid = "${fromid}";`;
            var objects = await osql.connect(sql);
            console.log(objects);
            var html = "";
            html += "<table border=1>";
            html += "<tr><th>toid</th><th>name</th></tr>";
            for (var i = 0; i < objects.length; i++) {
                var object = objects[i];
                html += "<tr>";
                html += "<td>" + object.toid + "</td>";
                html += "<td>" + object.name + "</td>";
                html += "</tr>";
            }
            html += "</table>";
            document.getElementById("following-table").innerHTML = html;
        }

        async function showFollowers() {
            var toid = document.getElementById("tf1").value;
            var sql = `select fromid, name from Users inner join Follows on Users.id = Follows.fromid where toid = "${toid}";`;
            var objects = await osql.connect(sql);
            console.log(objects);
            var html = "";
            html += "<table border=1>";
            html += "<tr><th>fromid</th><th>name</th></tr>";
            for (var i = 0; i < objects.length; i++) {
                var object = objects[i];
                html += "<tr>";
                html += "<td>" + object.fromid + "</td>";
                html += "<td>" + object.name + "</td>";
                html += "</tr>";
            }
            html += "</table>";
            document.getElementById("followers-table").innerHTML = html;
        }
    </script>

</head>

<body>
    <h1>フォロー</h1>
    フォロー元のID:
    <input id="tf1" type="text" disabled>
    <br> フォロー先のID:
    <input id="tf2" type="text">
    <button onclick="">フォロー</button>
    <p id="tweet-result"><br></p>
    <hr>
    <div style="float: left;">
        <h3>ユーザ一覧</h3>
        <p id="users-table"></p>
    </div>
    <div style="float: left; margin-left: 20px;">
        <h3>フォロー中</h3>
        <p id="following-table"></p>
    </div>
    <div style="float: left; margin-left: 20px;">
        <h3>フォロワー</h3>
        <p id="followers-table"></p>
    </div>
</body>

</html>